---
page_type: sample
description: "В этом примере ASP.NET MVC показано, как начать получать уведомления от Microsoft Graph."
products:
- office-365
languages:
- javascript
extensions:
  contentType: samples
  technologies:
  - Mirosoft Graph
  - Microsoft identity platform
  platforms:
  - REST API
  createdDate: 3/9/2016 4:10:08 PM
---
# Веб-перехватчики Microsoft Graph ASP.NET

Подпишитесь на [веб-перехватчики Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks) для получения оповещений об изменениях ваших данных пользователя, чтобы не выполнять опрос на изменения.

В этом примере ASP.NET MVC показано, как начать получать уведомления от Microsoft Graph. Microsoft Graph предоставляет единую конечную точку API для доступа к данным из Microsoft Cloud.

> В этом примере используется конечная точка Azure AD V2, чтобы получить маркер доступа для рабочих или учебных учетных записей. В примере используется делегированное пользователем разрешение, но сообщения, события и ресурсы контактов также поддерживают разрешения приложения (только для приложений). В настоящее время только ресурсы элементов в корне диска поддерживают подписки для личных учетных записей. Следите за обновлением документов, по мере того как мы добавляем поддержку для этих и других функций.

Ниже приведены некоторые общие задачи, выполняемые приложением при наличии подписки на веб-перехватчики:

- Получение согласия на подписку на ресурсы пользователей, а затем получение маркера доступа.
- Использование маркера доступа, чтобы [создать подписку](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/subscription_post_subscriptions) на ресурс.
- Возврат маркера проверки для подтверждения URL-адреса уведомления.
- Отслеживание уведомлений из Microsoft Graph и ответ с кодом состояния 202.
- Запрос дополнительных сведений об измененных ресурсах с помощью данных в уведомлении.

На снимке экрана показана начальная страница приложения после входа пользователя.

![Снимок экрана для примера веб-перехватчиков Microsoft Graph для ASP.NET](readme-images/Page1.PNG)

После того как приложение создаст подписку для вошедшего в систему пользователя Microsoft Graph отправляет уведомление в зарегистрированную конечную точку, если в данных пользователя происходят события. Приложение реагирует на событие.

Этот пример выполняет подписку на ресурс `me/mailFolders('Inbox')/messages` для изменений`created` (создано). При получении уведомления о том, что пользователь получил сообщение электронной почты, страница со сведениями о нем обновляется.

## Обязательные условия

Чтобы использовать пример веб-перехватчика Microsoft Graph ASP.NET, потребуется следующее:

- Набор инструментов Visual Studio 2017, установленный на компьютере для разработки.
- [Рабочая или учебная учетная запись](http://dev.office.com/devprogram).
- Идентификатор приложения и ключ из приложения, которое вы [регистрируете на портале регистрации приложений](#register-the-app).
- Открытая конечная точка HTTPS для получения и отправки HTTP-запросов. Вы можете разместить ее на Microsoft Azure или другой службе, а также [использовать ngrok](#set-up-the-ngrok-proxy-optional) или аналогичный инструмент во время тестирования.

### Регистрация приложения
Выполняя это упражнение, вы создадите регистрацию для нового веб-приложения Azure AD с помощью центра администрирования Azure Active Directory.

1. Определите URL-адрес приложения ASP.NET. В обозревателе решений Visual Studio выберите проект **GraphWebhooks**. В окне **Свойства** найдите **URL-адрес SSL**. Скопируйте его.

    ![Снимок экрана: окно "Свойства" в Visual Studio](readme-images/vs-project-url.PNG)

1. Откройте браузер и перейдите в [Центр администрирования Azure Active Directory](https://aad.portal.azure.com). Войдите с помощью **рабочей или учебной учетной записи**.

1. Выберите **Azure Active Directory** на панели навигации слева, а затем — пункт **Регистрация приложения** в разделе **Управление**.

    ![Снимок экрана: пункт "Регистрация приложения"](readme-images/aad-portal-app-registrations.png)

1. Выберите **Новая регистрация**. На странице **Регистрация приложения** задайте необходимые значения следующим образом:

    - Задайте предпочитаемое **имя**, например `Пример GraphWebhooks`.
    - Задайте для параметра **Поддерживаемые типы учетных записей** значение **Учетные записи в любом каталоге организации**.
    - В разделе **URI перенаправления** выберите в первом раскрывающемся списке пункт `Интернет` и установите значение URL-адреса приложения ASP.NET, поддерживающего SSL, который вы скопировали на шаге 1.

    ![Снимок экрана: страница "Регистрация приложения"](readme-images/aad-register-an-app.png)

1. Нажмите кнопку **Зарегистрировать**. На странице **Примера GraphWebhooks** скопируйте значение **Идентификатор приложения (клиента)** и сохраните его — оно потребуется на следующем шаге.

    ![Снимок экрана: идентификатор приложения для новой регистрации](readme-images/aad-application-id.PNG)

1. Выберите **Проверка подлинности** в разделе **Управление**. Найдите раздел **Неявное предоставление разрешения** и включите **Маркеры ИД**. Нажмите кнопку **Сохранить**.

    ![Снимок экрана: раздел "Неявное предоставление"](readme-images/aad-implicit-grant.png)

1. Выберите **Сертификаты и секреты** в разделе **Управление**. Нажмите кнопку **Новый секрет клиента**. Введите значение в поле **Описание**, выберите один из вариантов для **Срок действия** и нажмите **Добавить**.

    ![Снимок экрана: диалоговое окно "Добавление секрета клиента"](readme-images/aad-new-client-secret.png)

1. Скопируйте значение секрета клиента, а затем покиньте эту страницу. Оно вам понадобится на следующем шаге.

    > [ВАЖНО!]
    > Этот секрет клиента больше не будет отображаться, поэтому обязательно скопируйте его.

    ![Снимок экрана: только что добавленный секрет клиента](readme-images/aad-copy-client-secret.png)


### Настройка прокси-сервера ngrok (необязательно)

Чтобы создать подписку и получать уведомления от Microsoft Graph, нужно предоставить открытую конечную точку HTTPS. Во время тестирования вы можете использовать ngrok для временного разрешения туннелирования сообщений из Microsoft Graph на порт *localhost* на вашем компьютере.

Можно использовать веб-интерфейс ngrok ([http://127.0.0.1:4040](http://127.0.0.1:4040)), чтобы проверить трафик HTTP, проходящий по туннелю. Дополнительные сведения об использовании ngrok см. в статье [веб-сайт ngrok](https://ngrok.com/).

1. В обозревателе решений выберите проект **GraphWebhooks**.

1. Скопируйте номер порта **URL-адреса** в окне **Свойства**. Если окно **Свойства** не отображается, выберите **Вид > Окно свойств**.

    ![Номер порта URL-адреса в окне Свойства](readme-images/PortNumber.png)

1. [Скачайте ngrok](https://ngrok.com/download) для Windows.

1. Распакуйте пакет и запустите ngrok. exe.

1. Замените два значения заполнителей *{port-number}* в следующей команде на номер порта, который вы скопировали, а затем запустите команду в консоли ngrok.

    ```Shell
    ngrok http {port-number} -host-header=localhost:{port-number}
    ```

    ![Пример команды для выполнения в консоли ngrok](readme-images/ngrok1.PNG)

1. Скопируйте URL-адрес HTTPS, который отображается на консоли. Вы будете использовать его для настройки URL-адреса уведомления в примере.

    ![URL-адрес переадресации HTTPS на консоли ngrok](readme-images/ngrok2.PNG)

    > **Примечание.** Не закрывайте консоль во время тестирования. Если вы ее закроете, то также закроется туннель и вам потребуется создать новый URL-адрес и обновить пример.

В статье [Размещение без туннеля](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample/wiki/Hosting-the-sample-without-a-tunnel) и [Зачем использовать туннель?](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample/wiki/Why-do-I-have-to-use-a-tunnel) приведены дополнительные сведения.

## Настройка и запуск примера

1. Предоставьте открытую конечную точку HTTPS для уведомлений. Она может работать в службе, например в Microsoft Azure, или вы можете создать прокси веб-сервер [с помощью ngrok](#set-up-the-ngrok-proxy-optional) или аналогичных средств.

1. Скопируйте **GraphWebHooks/PrivateSettings.example.config** в тот же каталог. Переименуйте копию на **PrivateSettings.config**.

1. Откройте **GraphWebhooks.sln** в файлах примеров.

    > **Примечание.** Возможно, вам будет предложено доверять сертификатам для localhost.

1. В обозревателе решений откройте файл **PrivateSettings.config** в корневом каталоге проекта.
    - Для ключа **ClientId** замените *ENTER\_YOUR\_APP\_ID* идентификатором приложения своего зарегистрированного приложения.
    - Для ключа **ClientSecret** замените *ENTER\_YOUR\_SECRET* ключом своего зарегистрированного приложения.
    - Для ключа **NotificationUrl** замените *ENTER\_YOUR\_URL* на URL-адрес HTTPS. Оставьте часть */notification/listen*. Если вы используете ngrok, то используйте скопированный URL-адрес HTTPS. Значение будет выглядеть следующим образом:

    ```xml
    <add key="ida:NotificationUrl" value="https://0f6fd138.ngrok.io/notification/listen" />
    ```

1. Убедитесь в том, что консоль ngrok работает, и нажмите клавишу F5, чтобы построить и выполнить решение в режиме отладки.
    > **Примечание.** Если при установке пакетов возникают ошибки, то убедитесь, что локальный путь к решению не слишком длинный/глубокий. Чтобы устранить эту проблему, переместите решение ближе к корневому диску.
    >
    > При обновлении зависимостей в этом примере **не обновляйте** `System.IdentityModel.Tokens.Jwt` до версии 5, предназначенной для использования с .NET Core. Также не обновляйте библиотеки `Microsoft.Owin` до версии 4.

### Использование приложения

1. Войдите со своей рабочей или учебной учетной записью.

1. Дайте согласие на **Чтение почты** и **Вход и чтение профиля**.

    Если разрешение на **Чтение почты** не отображается, нажмите кнопку **Отмена** а затем добавьте разрешение на **Чтение почты пользователя** в приложении на портале Azure. Инструкции см. в статье[Регистрация приложения](#register-the-app).

1. Нажмите **Создать подписку**. Загружается страница **Подписка** со всей информацией о подписке.

    > **Примечание.** В этом примере срок действия подписки для целей тестирования истекает через 15 минут.

    ![Страница приложения, на которой показаны свойства новой подписки](readme-images/Page2.PNG)

1. Нажмите кнопку **Посмотреть уведомления**.

1. Отправьте сообщение в свою рабочую или учебную учетную запись. На странице **Уведомление** отображаются свойства сообщения. Обновление страницы может занять несколько секунд.

    ![Страница приложения, на которой показаны свойства нового сообщения](readme-images/Page3.PNG)

1. Нажмите кнопку **Удалить подписку и выйти**.

## Ключевые компоненты примера

### Контроллеры

- [`NotificationController.cs`](GraphWebhooks/Controllers/NotificationController.cs) получает уведомления.
- [`SubscriptionController.cs`](GraphWebhooks/Controllers/SubscriptionController.cs) создает и получает подписку на веб-перехватчики.

### Модели

- [`Message.cs`](GraphWebhooks/Models/Message.cs) определяет **MessageViewModel**, которая обозначает данные, отображаемые в представлении «Уведомление».
- [`Notification.cs`](GraphWebhooks/Models/Notification.cs) обозначает уведомление об изменениях.
- [`Subscription.cs`](GraphWebhooks/Models/Subscription.cs) определяет **SubscriptionViewModel**, которая обозначает данные, отображаемые в представлении подписки.

### Представления

- [`Notification/Notification.cshtml`](GraphWebhooks/Views/Notification/Notification.cshtml) отображает сведения о полученных сообщениях, и содержит кнопку **Удалить подписку и выйти**.
- [`Subscription/Index.cshtml`](GraphWebhooks/Views/Subscription/Index.cshtml) целевая страница с кнопкой **Создать подписку**.
- [`Subscription/Subscription.cshtml`](GraphWebhooks/Views/Subscription/Subscription.cshtml) отображает свойства подписки и содержит кнопку **Просмотр уведомлений**.

### Прочее

- [`Web.config`](GraphWebhooks/Web.config) содержит значения, используемые для проверки подлинности и авторизации.
- [`App_Start/Startup.Auth.cs`](GraphWebhooks/App_Start/Startup.Auth.cs) содержит код, используемый для проверки подлинности и авторизации. В этом примере для проверки подлинности и авторизации пользователя используются [OpenID Connect](https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-openid-connect-code) и [Библиотека проверки подлинности Майкрософт (MSAL)](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet).
- [`TokenStorage/SampleTokenCache.cs`](GraphWebhooks/TokenStorage/SampleTokenCache.cs) пример реализации кэша маркера, использующего System.Runtime.Caching (сведенья о маркере доступны после получения уведомления). Рабочие приложения обычно используют постоянное хранилище.
- [`Helpers/SubscriptionStore.cs`](GraphWebhooks/Helpers/SubscriptionStore.cs) уровень доступа для сохраненных сведений о подписке. Реализация примера временно содержит сведения в HttpRuntime.Cache. Рабочие приложения обычно используют постоянное хранилище.

## Устранение неполадок

Если вы столкнулись с ошибками или неполадками в этом примере, см. [документ устранения неполадок](TROUBLESHOOTING.md).

## Участие

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [часто задаваемых вопросов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Вопросы и комментарии

Мы будем рады получить ваши отзывы о примере веб-перехватчиков Microsoft Graph. Вы можете отправлять нам вопросы и предложения в разделе [Проблемы](https://github.com/microsoftgraph/aspnet-webhooks-rest-sample/issues) этого репозитория.

Общие вопросы о Microsoft Graph следует задавать на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph). Убедитесь, что ваши вопросы или комментарии содержат метку `MicrosoftGraph`.

Предложения, касающиеся работы различных функций и компонентов, размещайте на странице [Портал пользовательских предложений](https://officespdev.uservoice.com/). Здесь же можно проголосовать за понравившиеся предложения.

## Дополнительные ресурсы

- [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample)
- [Работа с веб-перехватчиками в Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks)
- [Ресурс подписки](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/subscription)
- [Сайт разработчика Microsoft Graph](https://developer.microsoft.com/en-us/graph/)
- [Вызов Microsoft Graph в приложении ASP.NET MVC](https://developer.microsoft.com/en-us/graph/docs/platform/aspnetmvc)

## Авторские права

(c) Корпорация Майкрософт (Microsoft Corporation), 2019. Все права защищены.
